<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:NewsReader.ViewModels"
             xmlns:models="clr-namespace:NewsReader.Models"
             x:DataType="viewmodel:NewsListViewModel"
             x:Class="NewsReader.Views.MainPage"
             Title="Daily News">

    <Grid RowDefinitions="Auto, Auto, *">

        <ActivityIndicator Grid.Row="2"
                   IsRunning="{Binding IsBusy}"
                   IsVisible="{Binding IsBusy}"
                   VerticalOptions="Center"
                   HorizontalOptions="Center"
                   Color="{StaticResource Primary}" />

        <SearchBar Grid.Row="0" 
           Placeholder="Sök efter ämne (t.ex. AI, Sport...)" 
           Text="{Binding SearchText}"
           SearchCommand="{Binding LoadCommand}" />


        <RefreshView Grid.Row="2" 
                     IsRefreshing="{Binding IsBusy}" 
                     Command="{Binding LoadCommand}">

            <CollectionView ItemsSource="{Binding Articles}"
                SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ArticleDto">
                        <Border Margin="12,6" 
                                Padding="0" 
                                StrokeThickness="0"
                                BackgroundColor="{AppThemeBinding Light=White, Dark=#212121}">

                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12" />
                            </Border.StrokeShape>

                            <Border.Shadow>
                                <Shadow Brush="Black" Offset="2,2" Radius="5" Opacity="0.2" />
                            </Border.Shadow>

                            <Border.GestureRecognizers>
                                <TapGestureRecognizer 
                                    
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:NewsListViewModel}}, Path=OpenDetailsCommand}"
                                        CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>

                            <Grid ColumnDefinitions="120, *">
                                <Image Grid.Column="0" 
                                       Source="{Binding UrlToImage, TargetNullValue='placeholder_news.png'}" 
                                       Aspect="AspectFill" 
                                       HeightRequest="120" />

                                <VerticalStackLayout Grid.Column="1" Padding="10" VerticalOptions="Center">
                                    <Label Text="{Binding Title}" 
                                           MaxLines="2" 
                                           LineBreakMode="TailTruncation" 
                                           FontAttributes="Bold" 
                                           FontSize="16" />

                                    <Label Text="{Binding Source.Name}" 
                                           FontSize="12" 
                                           TextColor="Gray" 
                                           Margin="0,5,0,0" />

                                    <Label Text="{Binding PublishedAt, StringFormat='{0:yyyy-MM-dd}'}" 
                                           FontSize="10" 
                                           TextColor="Silver" />
                                </VerticalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
    </Grid>
</ContentPage>